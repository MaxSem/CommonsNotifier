#!/bin/bash

# This bot's main workhorse - script that gets run periodically and performs
# all the work needed

source $(dirname $0)/vars.sh

echo "Starting cronjob with timestamp ${TIMESTAMP}"

(
    flock -n 9 || ( echo 'Previous cronjob still running, exiting' ; exit 0 )

    # Save old listfiles
    for f in ${DIR}/lists/*.txt; do
        # Skip if file doesn't exist of empty
        [ -e "$f" -o ! -s "$f" ] || continue
        mv -- "$f" "$f.${TIMESTAMP}"
    done

    ${BIN}/python3 ${DIR}/make-list.py
    ${BIN}/python3 ${DIR}/post-notifs.py
) 9> ${DIR}/lockfile

echo "Cronjob ${TIMESTAMP} finished at $(date)"
